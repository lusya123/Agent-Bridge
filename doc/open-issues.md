# Agent Bridge — 待解决问题清单

> 截至 Phase 6 实现完成（2026-02-12），集群组网功能已实现，以下为更新后的问题状态。

---

## 已解决（Phase 6）

| 问题 | 解决方案 |
|------|----------|
| 1.1 API 无认证 | Token Bearer 认证中间件，所有端点（/health 除外）需要 Authorization 头 |
| 2.1 静态集群配置 | ClusterManager 动态发现，/cluster/join 自动注册 |
| 2.2 无用户隔离 | Token 中的 secret 隔离不同集群 |
| 2.3 NAT 穿透 | Edge 节点通过 WebSocket 长连接到 Hub |
| 3.1 /agents 只返回本机 | `?scope=cluster` 参数返回集群全局视图 |
| 5.2 无 /health 端点 | `/health` 端点 + Hub 间心跳检测 |

---

## 待验证

### Phase 6 E2E 真机验证

**严重程度：高**

Phase 6 代码已实现并通过 153 个单元测试，但尚未在真实云服务器上验证。需要：
- 部署到 cloud-a 和 cloud-b
- 验证 Token 组网（第一台生成 Token，第二台用 Token 加入）
- 验证 Hub→Hub 注册和心跳
- 验证认证中间件（无 Token 请求被拒绝）
- 验证跨机器消息路由（带认证头）

---

## 仍待解决

### 1.2 机器间通信无加密

**严重程度：中**

Bridge 之间通过 HTTP 明文传输。Phase 6 的 Token 认证防止了未授权访问，但传输内容仍可被窃听。

**可能方案：** Hub 间升级 HTTPS，或使用 Tailscale 组网

### 3.2 同名 Agent 无法自动区分

**严重程度：低（Phase 5.5 已缓解）**

`machine` 参数可显式指定目标机器，但 Agent 需要知道机器 ID。

### 4.1 回调机制依赖 LLM 自觉执行

**严重程度：中**

回调指令是自然语言注入，LLM 可能忘记或格式错误。

**可能方案：** Bridge 层面任务状态追踪 + 超时告警

### 4.2 消息无持久化/队列

**严重程度：低**

目标不在线时消息丢失，无重试机制。

### 4.3 Agent 状态无同步

**严重程度：低**

Bridge 不知道 Agent 何时完成任务。

### 5.1 Gateway 重启后 Bridge 重连稳定性

**严重程度：低**

偶尔需要手动重启 Bridge。

---

## 优先级建议

| 优先级 | 问题 | 状态 |
|--------|------|------|
| P0 | Phase 6 E2E 真机验证 | 待执行 |
| P1 | 1.2 通信加密 | 待定 |
| P1 | 4.1 回调可靠性 | 待定 |
| P3 | 4.2 消息持久化 | — |
| P3 | 5.1 重连稳定性 | — |
